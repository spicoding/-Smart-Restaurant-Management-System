<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | DineEase SRMS</title>
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- IMPORTED STYLES FROM PROJECT --- */
        :root {
            --brand-1: #E85D46;
            --brand-2: #C6AD67;
            --accent: #FE9C00;
            --muted: #7a7a7a;
            --bg: #f7f8f9;
            --white: #ffffff;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f1c40f;
            --info: #3498db;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: #222; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 260px;
            background: var(--brand-1);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .brand { 
            font-size: 1.4rem; 
            font-weight: 600; 
            color: white; 
            margin-bottom: 40px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .nav-item {
            padding: 14px 18px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { 
            background: var(--brand-2); 
            color: white; 
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Logout Link Styling */
        .logout-link {
            margin-top: auto; 
            color: #fab1a0 !important;
            text-decoration: none;
        }
        .logout-link:hover { background: rgba(231, 76, 60, 0.2); color: white !important; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .top-header { 
            background: white;
            padding: 20px 30px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            border-bottom: 1px solid #eee;
        }

        .scrollable-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* --- WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { 
            background: white; padding: 20px; border-radius: 14px; 
            box-shadow: 0 6px 20px rgba(16,24,40,0.04); position: relative; overflow: hidden; border: 1px solid #eee;
        }
        .stat-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--brand-2); }
        .stat-label { font-size: 0.85rem; color: var(--muted); font-weight: 500; }
        .stat-number { font-size: 1.8rem; font-weight: 600; color: var(--brand-1); margin-top: 5px; }

        /* --- TABLES --- */
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .table-card {
            background: white; padding: 20px; border-radius: 14px;
            box-shadow: 0 6px 20px rgba(16,24,40,0.04); text-align: center; 
            border-top: 6px solid var(--success); transition: transform 0.2s;
        }
        .table-card:hover { transform: translateY(-5px); }
        .table-card.occupied { border-top-color: var(--danger); background: #fff5f5; }
        
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; 
            display: inline-block; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-free { background: #dcfce7; color: var(--success); }
        .status-busy { background: #fee2e2; color: var(--danger); }
        
        /* Order Status Colors */
        .st-pending { background: #fff3cd; color: #856404; } 
        .st-preparing { background: #cce5ff; color: #004085; } 
        .st-ready { background: #d4edda; color: #155724; } 
        .st-delivered { background: #d6d8d9; color: #1b1e21; } 

        /* --- DATA TABLE --- */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px rgba(16,24,40,0.04); }
        th { background: var(--brand-1); color: white; padding: 16px; text-align: left; font-weight: 500; }
        td { padding: 16px; border-bottom: 1px solid #f0f0f0; color: #444; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }

        /* --- CONTROLS --- */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--brand-2); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-secondary { background: var(--muted); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-bottom: 15px; font-family: 'Poppins', sans-serif; }
        /* Custom File Input */
        input[type="file"] { padding: 8px; background: white; }

        /* --- QR GENERATOR --- */
        .qr-card {
            background: white; border-radius: 14px; padding: 40px; text-align: center;
            box-shadow: 0 6px 20px rgba(16,24,40,0.04); max-width: 500px; margin: 0 auto;
        }
        .qr-display { margin: 20px 0; padding: 20px; border: 2px dashed var(--brand-2); display: inline-block; border-radius: 10px; }
        .qr-display img { width: 180px; height: 180px; }

        /* --- UTILS --- */
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Staff List Styling */
        .staff-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .staff-list-item:last-child { border-bottom: none; }
        .role-badge { padding: 2px 8px; border-radius: 10px; background: #eee; font-size: 0.8rem; color: #555; margin-left:10px; }
        .staff-status { font-size: 0.8rem; margin-left: 10px; font-weight: bold; cursor: pointer; padding: 2px 8px; border-radius: 4px; }
        .status-active { color: var(--success); background: #e6ffed; border: 1px solid var(--success); }
        .status-absent { color: var(--danger); background: #ffe6e6; border: 1px solid var(--danger); }
        
        /* Menu Image Thumbnail */
        .menu-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-utensils"></i> DineEase <span style="color:var(--accent)">Admin</span>
        </div>
        
        <div class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-th-large"></i> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('tables')">
            <i class="fas fa-chair"></i> Floor Plan
        </div>
        <div class="nav-item" onclick="showSection('staff')">
            <i class="fas fa-users"></i> Staff Dept.
        </div>
        <div class="nav-item" onclick="showSection('qr-gen')">
            <i class="fas fa-qrcode"></i> QR Tools
        </div>
        <div class="nav-item" onclick="showSection('menu')">
            <i class="fas fa-hamburger"></i> Menu
        </div>
        
        <!-- UPDATED LOGOUT LINK -->
        <a href="../frontend/staff_login.html" class="nav-item logout-link">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <div class="top-header">
            <h2 style="margin:0; font-size:1.5rem; color:var(--brand-1);">Overview</h2>
            <div class="user-info" style="display:flex; align-items:center; gap:10px;">
                <span style="color:var(--muted);">Logged in as </span>
                <strong style="color:var(--brand-1);">Manager</strong>
                <div style="width:35px; height:35px; background:var(--brand-2); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center;">M</div>
            </div>
        </div>

        <div class="scrollable-content">
            
            <!-- ================= TAB 1: DASHBOARD ================= -->
            <div id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Orders</div>
                        <div class="stat-number" id="activeOrdersCount">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--accent);">
                        <div class="stat-label">Tables Occupied</div>
                        <div class="stat-number" id="occupiedTablesCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Kitchen Queue</div>
                        <div class="stat-number" id="kitchenQueueCount">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #9b59b6;">
                        <div class="stat-label">Bar Queue</div>
                        <div class="stat-number" id="barQueueCount">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-label">Revenue (KSH)</div>
                        <div class="stat-number" id="revenueCount">12,400</div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>Live Order Monitor</h3>
                    <div style="font-size:0.9rem; color:var(--muted)">
                        <span class="status-badge st-preparing">Preparing</span> = Working
                        <span class="status-badge st-ready">Ready</span> = Done
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>Table</th>
                            <th>Waitstaff</th>
                            <th>Order Details</th>
                            <th>Kitchen Status</th>
                            <th>Bar Status</th>
                        </tr>
                    </thead>
                    <tbody id="incomingOrdersTable">
                        <!-- JS Populated -->
                    </tbody>
                </table>
            </div>

            <!-- ================= TAB 2: TABLE MANAGEMENT ================= -->
            <div id="tables" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Floor Plan & Assignments</h3>
                    <div style="display:flex; gap:10px">
                        <div style="display:flex; gap:5px; background:white; padding:5px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05)">
                            <input type="number" id="newTableSeats" placeholder="Seats" style="margin:0; width:80px; padding:8px;">
                            <button class="btn btn-primary btn-sm" onclick="addTable()">Add Table</button>
                        </div>
                        <button class="btn btn-accent" onclick="simulateCustomerArrival()">
                            <i class="fas fa-user-plus"></i> Simulate Arrival
                        </button>
                    </div>
                </div>
                <div class="tables-grid" id="tablesGrid">
                    <!-- JS Populated -->
                </div>
            </div>

            <!-- ================= TAB 3: STAFF MANAGEMENT ================= -->
            <div id="staff" class="section">
                <h3>Staff Management</h3>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <!-- Add Staff Form -->
                    <div class="stat-card">
                        <h4 style="margin-top:0; color:var(--brand-2);">Register New Staff</h4>
                        <input type="text" id="newStaffName" placeholder="Full Name">
                        <select id="newStaffRole">
                            <option value="Waiter">Waiter</option>
                            <option value="Chef">Chef</option>
                            <option value="Bartender">Bartender</option>
                            <option value="Cashier">Cashier</option>
                        </select>
                        <button class="btn btn-success" style="width:100%" onclick="addStaff()">
                            <i class="fas fa-user-plus"></i> Register Staff
                        </button>
                    </div>
                    
                    <!-- Staff List -->
                    <div class="stat-card" style="border-left-color: var(--info);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 style="margin-top:0; color:var(--info);">Staff Directory</h4>
                            <span style="font-size:0.8rem; color:var(--muted)">Active Staff Available: <strong id="activeStaffCount">0</strong></span>
                        </div>
                        <div id="staffList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 4: QR GENERATOR ================= -->
            <div id="qr-gen" class="section">
                <div class="qr-card">
                    <h3 style="color:var(--brand-1)">Generate Table QR</h3>
                    <p style="color:var(--muted)">Select a table to generate its unique menu ordering code.</p>
                    
                    <select id="qrTableSelect" onchange="generateQR()">
                        <!-- Options Populated via JS -->
                    </select>

                    <div class="qr-display">
                        <img id="qrImage" src="" alt="QR Code will appear here">
                    </div>
                    
                    <div id="qrText" style="font-weight:bold; margin-bottom:20px; color:var(--brand-1)">Table 1</div>

                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn btn-secondary" onclick="generateQR()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-primary" onclick="printQR()">
                            <i class="fas fa-print"></i> Print Label (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 5: MENU MANAGER ================= -->
            <div id="menu" class="section">
                <h3>Menu Management</h3>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                    <!-- Add Form -->
                    <div class="stat-card">
                        <h4 style="margin-top:0; color:var(--brand-2);">Add New Item</h4>
                        <input type="text" id="newItemName" placeholder="Item Name">
                        
                        <!-- NEW FILE INPUT -->
                        <label style="font-size:0.8rem; color:var(--muted); display:block; margin-bottom:5px;">Item Image</label>
                        <input type="file" id="newItemImage" accept="image/*">
                        
                        <input type="number" id="newItemPrice" placeholder="Price (KSH)">
                        <select id="newItemCategory">
                            <option value="Appetizer">Appetizer</option>
                            <option value="Starter">Starter</option>
                            <option value="Main">Main Course</option>
                            <option value="Drink">Drink</option>
                            <option value="Dessert">Dessert</option>
                        </select>
                        <button class="btn btn-success" style="width:100%" onclick="addMenuItem()">
                            <i class="fas fa-save"></i> Save to Menu
                        </button>
                    </div>
                    <!-- List -->
                    <div>
                        <table id="menuTable">
                            <thead><tr><th>Image</th><th>Item</th><th>Category</th><th>Price</th><th>Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA ---
        let staffMembers = [
            { name: 'Alice', role: 'Waiter', active: true },
            { name: 'Bob', role: 'Waiter', active: true },
            { name: 'Charlie', role: 'Bartender', active: true },
            { name: 'Sarah', role: 'Chef', active: true }
        ];
        
        let tables = [
            { id: 1, capacity: 4, status: 'free', waiter: null },
            { id: 2, capacity: 2, status: 'free', waiter: null },
            { id: 3, capacity: 6, status: 'free', waiter: null },
            { id: 4, capacity: 4, status: 'free', waiter: null },
            { id: 5, capacity: 2, status: 'free', waiter: null },
        ];

        let orders = [];
        let menuItems = [
            { name: "Grilled Tilapia", category: "Main", price: 1200, image: "https://via.placeholder.com/50" },
            { name: "Dawa Cocktail", category: "Drink", price: 450, image: "https://via.placeholder.com/50" }
        ];

        // --- NAVIGATION ---
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Handle Logout Link Special Case
            if (event.currentTarget && event.currentTarget.classList.contains('logout-link')) return;

            document.getElementById(sectionId).classList.add('active');
            if (event.currentTarget) event.currentTarget.classList.add('active');
            
            const titleMap = {
                'dashboard': 'Overview', 'tables': 'Floor Management', 'staff': 'Staff Directory',
                'qr-gen': 'QR Tools', 'menu': 'Menu Settings'
            };
            document.querySelector('.top-header h2').innerText = titleMap[sectionId];

            if(sectionId === 'qr-gen') updateQROptions(); 
            if(sectionId === 'staff') renderStaffList();
        }

        // --- RENDERERS ---
        function renderOrders() {
            const tbody = document.getElementById('incomingOrdersTable');
            tbody.innerHTML = '';
            let activeCount = 0;
            let kitchenCount = 0;
            let barCount = 0;

            orders.forEach(order => {
                if (order.status !== 'completed') {
                    activeCount++;
                    if(order.kitchenStatus === 'preparing' || order.kitchenStatus === 'pending') kitchenCount++;
                    if(order.barStatus === 'preparing' || order.barStatus === 'pending') barCount++;

                    const tr = document.createElement('tr');
                    
                    // Determine Waiter Status
                    let assignedWaiter = tables.find(t => t.id === order.tableId)?.waiter;
                    let waiterDisplay = assignedWaiter ? `<span style="color:var(--brand-2); font-weight:bold;">${assignedWaiter}</span>` : `<span style="color:var(--danger)">Unassigned</span>`;
                    
                    // Determine Order Details Display (Hide if no waiter)
                    let itemsDisplay = assignedWaiter ? order.items : `<span style="color:var(--muted); font-style:italic;">Waiting for waiter...</span>`;

                    tr.innerHTML = `
                        <td>#${order.id}</td>
                        <td><strong>Table ${order.tableId}</strong></td>
                        <td>${waiterDisplay}</td>
                        <td>${itemsDisplay}</td>
                        <td><span class="status-badge ${getStatusClass(order.kitchenStatus)}" 
                                  style="cursor:pointer" onclick="cycleStatus(${order.id}, 'kitchenStatus')">
                            ${order.kitchenStatus} <i class="fas fa-sync-alt" style="font-size:0.7em; opacity:0.5"></i>
                        </span></td>
                        <td><span class="status-badge ${getStatusClass(order.barStatus)}" 
                                  style="cursor:pointer" onclick="cycleStatus(${order.id}, 'barStatus')">
                            ${order.barStatus} <i class="fas fa-sync-alt" style="font-size:0.7em; opacity:0.5"></i>
                        </span></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.getElementById('activeOrdersCount').innerText = activeCount;
            document.getElementById('kitchenQueueCount').innerText = kitchenCount;
            document.getElementById('barQueueCount').innerText = barCount;
        }

        function renderTables() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';
            let occupiedCount = 0;

            const waiterOptions = staffMembers.filter(s => s.role === 'Waiter' && s.active);

            tables.forEach(t => {
                if(t.status === 'occupied') occupiedCount++;
                const card = document.createElement('div');
                card.className = `table-card ${t.status === 'occupied' ? 'occupied' : ''}`;
                
                let waiterSelect = `<select onchange="assignTableWaiter(${t.id}, this.value)" style="margin-top:10px; padding:5px; width:100%; font-size:0.9rem">
                                        <option value="">-- Assign Waiter --</option>`;
                waiterOptions.forEach(w => {
                    waiterSelect += `<option value="${w.name}" ${t.waiter === w.name ? 'selected' : ''}>${w.name}</option>`;
                });
                waiterSelect += `</select>`;

                card.innerHTML = `
                    <h3>Table ${t.id}</h3>
                    <div class="status-badge ${t.status === 'free' ? 'status-free' : 'status-busy'}">${t.status}</div>
                    <div style="color:var(--muted); font-size:0.85rem;">${t.capacity} Seats</div>
                    ${t.status === 'occupied' ? waiterSelect : '<div style="height:40px"></div>'}
                    ${t.status === 'occupied' 
                        ? `<button class="btn btn-success btn-sm" onclick="checkoutTable(${t.id})" style="margin-top:15px; width:100%">
                             Mark Free & Done
                           </button>` 
                        : ''}
                `;
                grid.appendChild(card);
            });
            document.getElementById('occupiedTablesCount').innerText = occupiedCount;
        }

        function renderStaffList() {
            const list = document.getElementById('staffList');
            let html = '';
            let activeCount = 0;
            
            staffMembers.forEach((s, index) => {
                if(s.active) activeCount++;
                html += `
                    <div class="staff-list-item">
                        <div style="display:flex; align-items:center;">
                            <span class="staff-status ${s.active ? 'status-active' : 'status-absent'}" 
                                  onclick="toggleStaffStatus(${index})">
                                  ${s.active ? 'Active' : 'Absent'} <i class="fas fa-sync-alt" style="font-size:0.7em"></i>
                            </span>
                            <span style="margin-left:15px; font-weight:500;">${s.name}</span>
                            <span class="role-badge">${s.role}</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeStaff(${index})">Remove</button>
                    </div>
                `;
            });
            list.innerHTML = html;
            document.getElementById('activeStaffCount').innerText = activeCount;
        }

        function renderMenu() {
            const tbody = document.querySelector('#menuTable tbody');
            tbody.innerHTML = '';
            menuItems.forEach((item, index) => {
                const imgUrl = item.image || 'https://via.placeholder.com/50';
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${imgUrl}" class="menu-thumb" alt="Item"></td>
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>KSH ${item.price}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteMenuItem(${index})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        // --- ACTIONS ---
        function addStaff() {
            const name = document.getElementById('newStaffName').value;
            const role = document.getElementById('newStaffRole').value;
            if(name) {
                staffMembers.push({ name: name, role: role, active: true });
                renderStaffList();
                renderTables(); 
                document.getElementById('newStaffName').value = '';
            }
        }

        function toggleStaffStatus(index) {
            staffMembers[index].active = !staffMembers[index].active;
            renderStaffList();
            renderTables();
        }

        function removeStaff(index) {
            if(confirm("Permanently remove " + staffMembers[index].name + "?")) {
                staffMembers.splice(index, 1);
                renderStaffList();
                renderTables();
            }
        }

        function addMenuItem() {
            const name = document.getElementById('newItemName').value;
            const price = document.getElementById('newItemPrice').value;
            const cat = document.getElementById('newItemCategory').value;
            
            // Image Upload Logic
            const fileInput = document.getElementById('newItemImage');
            const file = fileInput.files[0];
            
            if(name && price) {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        menuItems.push({name, category: cat, price, image: e.target.result});
                        renderMenu();
                    };
                    reader.readAsDataURL(file);
                } else {
                    menuItems.push({name, category: cat, price, image: "https://via.placeholder.com/50"});
                    renderMenu();
                }
                
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                fileInput.value = '';
            }
        }

        // --- QR PRINT LOGIC ---
        function printQR() {
            const tableId = document.getElementById('qrTableSelect').value;
            const imgUrl = document.getElementById('qrImage').src;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Table ${tableId} QR</title>
                    <style>
                        body { text-align: center; font-family: sans-serif; padding: 50px; }
                        .qr-box { border: 2px solid #333; padding: 20px; display: inline-block; border-radius: 10px; }
                        img { width: 300px; height: 300px; }
                        h1 { color: #116466; margin-bottom: 5px; }
                        p { font-size: 1.2rem; color: #555; }
                        .no-print { margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="qr-box">
                        <h1>Table ${tableId}</h1>
                        <img src="${imgUrl}">
                        <p>Scan to Order Menu</p>
                    </div>
                    <div class="no-print">
                        <button onclick="window.print()" style="padding:10px 20px; font-size:1.2rem; cursor:pointer;">Print Now</button>
                        <button onclick="window.close()" style="padding:10px 20px; font-size:1.2rem; cursor:pointer;">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // --- EXISTING HELPER FUNCTIONS ---
        function updateQROptions() {
            const select = document.getElementById('qrTableSelect');
            select.innerHTML = '';
            tables.forEach(t => { select.innerHTML += `<option value="${t.id}">Table ${t.id}</option>`; });
            generateQR();
        }
        function generateQR() {
            const tableId = document.getElementById('qrTableSelect').value;
            const data = `https://dineease.com/menu?table=${tableId}`; 
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data)}`;
            document.getElementById('qrText').innerText = `Table ${tableId}`;
        }
        function addTable() {
            const seats = document.getElementById('newTableSeats').value;
            if(seats && seats > 0) {
                const newId = tables.length + 1;
                tables.push({ id: newId, capacity: parseInt(seats), status: 'free', waiter: null });
                renderTables();
            }
        }
        function simulateCustomerArrival() {
            const freeTable = tables.find(t => t.status === 'free');
            if (!freeTable) { alert("No tables available!"); return; }
            freeTable.status = 'occupied';
            renderTables();
            // Simulate Order
            setTimeout(() => {
                const newOrder = {
                    id: Math.floor(Math.random() * 10000),
                    tableId: freeTable.id,
                    items: "Steak, Red Wine",
                    status: 'active',
                    kitchenStatus: 'pending',
                    barStatus: 'pending'
                };
                orders.push(newOrder);
                renderOrders(); 
            }, 1000);
        }
        function assignTableWaiter(tableId, waiterName) {
            const table = tables.find(t => t.id === tableId);
            if(table) { table.waiter = waiterName; renderOrders(); }
        }
        function cycleStatus(orderId, type) {
            const order = orders.find(o => o.id === orderId);
            if(!order) return;
            const flow = ['pending', 'preparing', 'ready'];
            let current = order[type];
            let nextIndex = (flow.indexOf(current) + 1) % flow.length;
            order[type] = flow[nextIndex];
            renderOrders();
        }
        function getStatusClass(status) {
            if(status === 'pending') return 'st-pending';
            if(status === 'preparing') return 'st-preparing';
            if(status === 'ready') return 'st-ready';
            return 'st-delivered';
        }
        function checkoutTable(tableId) {
            if(confirm("Clear table?")) {
                const table = tables.find(t => t.id === tableId);
                table.status = 'free'; table.waiter = null;
                const order = orders.find(o => o.tableId === tableId && o.status !== 'completed');
                if(order) order.status = 'completed';
                renderTables(); renderOrders();
            }
        }
        function deleteMenuItem(index) { menuItems.splice(index, 1); renderMenu(); }

        // --- INIT ---
        renderTables(); renderMenu();
    </script>
</body>
</html>